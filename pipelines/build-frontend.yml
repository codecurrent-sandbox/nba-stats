# NBA Stats Frontend Build Pipeline
# Builds the React frontend application and analyzes bundle metrics

name: 'Frontend-Build-$(Date:yyyyMMdd)-$(Rev:r)'

resources:
  pipelines:
    - pipeline: infraPipeline
      source: 'NBA-Stats-Infra-Deploy'  # Name of the infrastructure pipeline
      trigger: none  # Infrastructure triggers API, not frontend directly
    - pipeline: apiPipeline
      source: 'NBA-Stats-API-Deploy'  # Name of the API pipeline
      trigger:
        branches:
          include:
            - main

trigger:
  branches:
    include:
      - main
  paths:
    include:
      - frontend/**
      - pipelines/build-frontend.yml

pr:
  branches:
    include:
      - main
  paths:
    include:
      - frontend/**
      - pipelines/build-frontend.yml

variables:
  - name: nodeVersion
    value: '20.x'
  - name: workingDirectory
    value: 'frontend'
  - name: vmImage
    value: 'ubuntu-latest'
  - name: buildMode
    value: 'production'
  - name: imageName
    value: 'nba-stats-frontend'
  - name: dockerfilePath
    value: 'frontend/Dockerfile'
  - name: buildContext
    value: 'frontend'
  - name: skipNugetSecurityAnalysis
    value: 'true'

stages:
  # ==============================================================================
  # STAGE 1: Prep - Setup environment and dependencies
  # ==============================================================================
  - stage: Prep
    displayName: 'Prepare Build Environment'
    jobs:
      - job: PrepareEnvironment
        displayName: 'Setup Node.js and Dependencies'
        pool:
          vmImage: $(vmImage)
        steps:
          - checkout: self
            displayName: 'Checkout source code'

          - task: NodeTool@0
            displayName: 'Setup Node.js $(nodeVersion)'
            inputs:
              versionSpec: $(nodeVersion)

          - task: Cache@2
            displayName: 'Cache npm packages'
            inputs:
              key: 'npm | "$(Agent.OS)" | $(Build.SourcesDirectory)/frontend/package-lock.json'
              path: $(Pipeline.Workspace)/.npm
              restoreKeys: |
                npm | "$(Agent.OS)"

          - task: Bash@3
            displayName: 'Install dependencies'
            inputs:
              targetType: 'inline'
              workingDirectory: '$(Build.SourcesDirectory)/$(workingDirectory)'
              script: |
                npm ci --cache $(Pipeline.Workspace)/.npm --prefer-offline
                echo "Dependencies installed successfully"

  # ==============================================================================
  # STAGE 2: Quality - Type checking and linting
  # ==============================================================================
  - stage: Quality
    displayName: 'Code Quality Checks'
    dependsOn: Prep
    jobs:
      - job: TypeCheck
        displayName: 'TypeScript Type Checking'
        pool:
          vmImage: $(vmImage)
        steps:
          - checkout: self

          - task: NodeTool@0
            displayName: 'Setup Node.js $(nodeVersion)'
            inputs:
              versionSpec: $(nodeVersion)

          - task: Cache@2
            displayName: 'Restore npm cache'
            inputs:
              key: 'npm | "$(Agent.OS)" | $(Build.SourcesDirectory)/frontend/package-lock.json'
              path: $(Pipeline.Workspace)/.npm

          - task: Bash@3
            displayName: 'Install dependencies'
            inputs:
              targetType: 'inline'
              workingDirectory: '$(Build.SourcesDirectory)/$(workingDirectory)'
              script: |
                npm ci --cache $(Pipeline.Workspace)/.npm --prefer-offline

          - task: Bash@3
            displayName: 'Run TypeScript type check'
            inputs:
              targetType: 'inline'
              workingDirectory: '$(Build.SourcesDirectory)/$(workingDirectory)'
              script: |
                echo "Running TypeScript type checking..."
                npx tsc --noEmit
                echo "Type checking completed successfully"

      - job: Lint
        displayName: 'Run ESLint'
        pool:
          vmImage: $(vmImage)
        steps:
          - checkout: self

          - task: NodeTool@0
            displayName: 'Setup Node.js $(nodeVersion)'
            inputs:
              versionSpec: $(nodeVersion)

          - task: Cache@2
            displayName: 'Restore npm cache'
            inputs:
              key: 'npm | "$(Agent.OS)" | $(Build.SourcesDirectory)/frontend/package-lock.json'
              path: $(Pipeline.Workspace)/.npm

          - task: Bash@3
            displayName: 'Install dependencies'
            inputs:
              targetType: 'inline'
              workingDirectory: '$(Build.SourcesDirectory)/$(workingDirectory)'
              script: |
                npm ci --cache $(Pipeline.Workspace)/.npm --prefer-offline

          - task: Bash@3
            displayName: 'Run ESLint'
            inputs:
              targetType: 'inline'
              workingDirectory: '$(Build.SourcesDirectory)/$(workingDirectory)'
              script: |
                echo "Running ESLint validation..."
                npm run lint
                echo "ESLint validation completed successfully"

  # ==============================================================================
  # STAGE 3: Build - Docker image build
  # ==============================================================================
  - stage: Build
    displayName: 'Build Docker Image'
    dependsOn: Quality
    jobs:
      - job: BuildDockerImage
        displayName: 'Build Docker Image'
        pool:
          vmImage: $(vmImage)
        variables:
          targetEnvironment: 'dev'
        steps:
          - checkout: self

          - task: DownloadPipelineArtifact@2
            displayName: 'Download infrastructure outputs'
            continueOnError: true
            inputs:
              source: 'specific'
              project: '$(System.TeamProject)'
              pipeline: 'NBA-Stats-Infra-Deploy'
              runVersion: 'latest'
              artifact: 'deployment-$(targetEnvironment)'
              path: '$(Pipeline.Workspace)/infra-outputs'

          - task: AzureCLI@2
            displayName: 'Resolve API URL and build metadata'
            inputs:
              azureSubscription: 'azure-nba-stats-connection'
              scriptType: 'bash'
              scriptLocation: 'inlineScript'
              inlineScript: |
                set -euo pipefail

                TARGET_ENV='$(targetEnvironment)'
                ARTIFACT_PATH="$(Pipeline.Workspace)/infra-outputs/deployment-${TARGET_ENV}.json"

                API_HOST=""
                if [ -f "$ARTIFACT_PATH" ]; then
                  API_HOST=$(jq -r '.apiUrl // empty' "$ARTIFACT_PATH")
                  if [ "$API_HOST" = "null" ]; then
                    API_HOST=""
                  fi
                fi

                if [ -z "$API_HOST" ]; then
                  RESOURCE_GROUP="rg-nba-stats-${TARGET_ENV}"
                  APP_NAME="nba-stats-${TARGET_ENV}-api"
                  FQDN=$(az containerapp show --name "$APP_NAME" --resource-group "$RESOURCE_GROUP" --query 'properties.configuration.ingress.fqdn' -o tsv 2>/dev/null || true)
                  if [ -n "$FQDN" ]; then
                    API_HOST="https://${FQDN}"
                  fi
                fi

                if [ -z "$API_HOST" ]; then
                  echo "Unable to resolve API endpoint for environment '$TARGET_ENV'." >&2
                  exit 1
                fi

                API_URL="${API_HOST%/}/api"

                VERSION=$(jq -r '.version' "$(Build.SourcesDirectory)/frontend/package.json")
                SHORT_SHA=$(git rev-parse --short=7 HEAD)
                FULL_SHA=$(git rev-parse HEAD)
                IMAGE_TAG="${VERSION}-${SHORT_SHA}"

                echo "Resolved API URL: $API_URL"
                echo "Package Version: $VERSION"
                echo "Short SHA: $SHORT_SHA"
                echo "Image Tag: $IMAGE_TAG"

                echo "##vso[task.setvariable variable=viteApiUrl]$API_URL"
                echo "##vso[task.setvariable variable=packageVersion]$VERSION"
                echo "##vso[task.setvariable variable=shortSha]$SHORT_SHA"
                echo "##vso[task.setvariable variable=fullSha]$FULL_SHA"
                echo "##vso[task.setvariable variable=imageTag]$IMAGE_TAG"

          - task: Docker@2
            displayName: 'Build Docker image'
            inputs:
              command: 'build'
              Dockerfile: '$(dockerfilePath)'
              buildContext: '$(buildContext)'
              tags: |
                $(imageTag)
                latest
              arguments: '--build-arg VITE_API_URL=$(viteApiUrl)'

  # ==============================================================================
  # STAGE 4: Publish to Dev ACR
  # ==============================================================================
  - stage: Publish_Dev
    displayName: 'Publish: Dev'
    dependsOn: Build
    condition: and(succeeded(), eq(variables['Build.SourceBranch'], 'refs/heads/main'))
    jobs:
      - job: PushToACR
        displayName: 'Push to Dev ACR'
        pool:
          vmImage: $(vmImage)
        variables:
          targetEnvironment: 'dev'
        steps:
          - checkout: self

          - task: DownloadPipelineArtifact@2
            displayName: 'Download infrastructure outputs (Dev)'
            continueOnError: true
            inputs:
              source: 'specific'
              project: '$(System.TeamProject)'
              pipeline: 'NBA-Stats-Infra-Deploy'
              runVersion: 'latest'
              artifact: 'deployment-dev'
              path: '$(Pipeline.Workspace)/infra-outputs'

          - task: AzureCLI@2
            displayName: 'Resolve Dev API URL and image tag'
            inputs:
              azureSubscription: 'azure-nba-stats-connection'
              scriptType: 'bash'
              scriptLocation: 'inlineScript'
              inlineScript: |
                set -euo pipefail

                TARGET_ENV='$(targetEnvironment)'
                ARTIFACT_PATH="$(Pipeline.Workspace)/infra-outputs/deployment-${TARGET_ENV}.json"

                API_HOST=""
                if [ -f "$ARTIFACT_PATH" ]; then
                  API_HOST=$(jq -r '.apiUrl // empty' "$ARTIFACT_PATH")
                  if [ "$API_HOST" = "null" ]; then
                    API_HOST=""
                  fi
                fi

                if [ -z "$API_HOST" ]; then
                  RESOURCE_GROUP="rg-nba-stats-${TARGET_ENV}"
                  APP_NAME="nba-stats-${TARGET_ENV}-api"
                  FQDN=$(az containerapp show --name "$APP_NAME" --resource-group "$RESOURCE_GROUP" --query 'properties.configuration.ingress.fqdn' -o tsv 2>/dev/null || true)
                  if [ -n "$FQDN" ]; then
                    API_HOST="https://${FQDN}"
                  fi
                fi

                if [ -z "$API_HOST" ]; then
                  echo "Unable to resolve API endpoint for environment '$TARGET_ENV'." >&2
                  exit 1
                fi

                API_URL="${API_HOST%/}/api"

                VERSION=$(jq -r '.version' "$(Build.SourcesDirectory)/frontend/package.json")
                SHORT_SHA=$(git rev-parse --short=7 HEAD)
                IMAGE_TAG="${VERSION}-${SHORT_SHA}"

                echo "Resolved API URL: $API_URL"
                echo "Image Tag: $IMAGE_TAG"

                echo "##vso[task.setvariable variable=viteApiUrl]$API_URL"
                echo "##vso[task.setvariable variable=imageTag]$IMAGE_TAG"

          - task: Docker@2
            displayName: 'Build and push to Dev ACR'
            inputs:
              containerRegistry: 'acr-nba-stats-dev'
              repository: '$(imageName)'
              command: 'buildAndPush'
              Dockerfile: '$(dockerfilePath)'
              buildContext: '$(buildContext)'
              tags: |
                $(imageTag)
                latest
              arguments: '--build-arg VITE_API_URL=$(viteApiUrl)'

  # ==============================================================================
  # STAGE 5: Publish to Test ACR
  # ==============================================================================
  - stage: Publish_Test
    displayName: 'Publish: Test'
    dependsOn: Publish_Dev
    condition: and(succeeded(), eq(variables['Build.SourceBranch'], 'refs/heads/main'))
    jobs:
      - job: PushToACR
        displayName: 'Push to Test ACR'
        pool:
          vmImage: $(vmImage)
        variables:
          targetEnvironment: 'test'
        steps:
          - checkout: self

          - task: DownloadPipelineArtifact@2
            displayName: 'Download infrastructure outputs (Test)'
            continueOnError: true
            inputs:
              source: 'specific'
              project: '$(System.TeamProject)'
              pipeline: 'NBA-Stats-Infra-Deploy'
              runVersion: 'latest'
              artifact: 'deployment-test'
              path: '$(Pipeline.Workspace)/infra-outputs'

          - task: AzureCLI@2
            displayName: 'Resolve Test API URL and image tag'
            inputs:
              azureSubscription: 'azure-nba-stats-connection'
              scriptType: 'bash'
              scriptLocation: 'inlineScript'
              inlineScript: |
                set -euo pipefail

                TARGET_ENV='$(targetEnvironment)'
                ARTIFACT_PATH="$(Pipeline.Workspace)/infra-outputs/deployment-${TARGET_ENV}.json"

                API_HOST=""
                if [ -f "$ARTIFACT_PATH" ]; then
                  API_HOST=$(jq -r '.apiUrl // empty' "$ARTIFACT_PATH")
                  if [ "$API_HOST" = "null" ]; then
                    API_HOST=""
                  fi
                fi

                if [ -z "$API_HOST" ]; then
                  RESOURCE_GROUP="rg-nba-stats-${TARGET_ENV}"
                  APP_NAME="nba-stats-${TARGET_ENV}-api"
                  FQDN=$(az containerapp show --name "$APP_NAME" --resource-group "$RESOURCE_GROUP" --query 'properties.configuration.ingress.fqdn' -o tsv 2>/dev/null || true)
                  if [ -n "$FQDN" ]; then
                    API_HOST="https://${FQDN}"
                  fi
                fi

                if [ -z "$API_HOST" ]; then
                  echo "Unable to resolve API endpoint for environment '$TARGET_ENV'." >&2
                  exit 1
                fi

                API_URL="${API_HOST%/}/api"

                VERSION=$(jq -r '.version' "$(Build.SourcesDirectory)/frontend/package.json")
                SHORT_SHA=$(git rev-parse --short=7 HEAD)
                IMAGE_TAG="${VERSION}-${SHORT_SHA}"

                echo "Resolved API URL: $API_URL"
                echo "Image Tag: $IMAGE_TAG"

                echo "##vso[task.setvariable variable=viteApiUrl]$API_URL"
                echo "##vso[task.setvariable variable=imageTag]$IMAGE_TAG"

          - task: Docker@2
            displayName: 'Build and push to Test ACR'
            inputs:
              containerRegistry: 'acr-nba-stats-test'
              repository: '$(imageName)'
              command: 'buildAndPush'
              Dockerfile: '$(dockerfilePath)'
              buildContext: '$(buildContext)'
              tags: |
                $(imageTag)
                latest
              arguments: '--build-arg VITE_API_URL=$(viteApiUrl)'

  # ==============================================================================
  # STAGE 6: Publish to Prod ACR
  # ==============================================================================
  - stage: Publish_Prod
    displayName: 'Publish: Prod'
    dependsOn: Publish_Test
    condition: and(succeeded(), eq(variables['Build.SourceBranch'], 'refs/heads/main'))
    jobs:
      - job: PushToACR
        displayName: 'Push to Prod ACR'
        pool:
          vmImage: $(vmImage)
        variables:
          targetEnvironment: 'prod'
        steps:
          - checkout: self

          - task: DownloadPipelineArtifact@2
            displayName: 'Download infrastructure outputs (Prod)'
            continueOnError: true
            inputs:
              source: 'specific'
              project: '$(System.TeamProject)'
              pipeline: 'NBA-Stats-Infra-Deploy'
              runVersion: 'latest'
              artifact: 'deployment-prod'
              path: '$(Pipeline.Workspace)/infra-outputs'

          - task: AzureCLI@2
            displayName: 'Resolve Prod API URL and image tag'
            inputs:
              azureSubscription: 'azure-nba-stats-connection'
              scriptType: 'bash'
              scriptLocation: 'inlineScript'
              inlineScript: |
                set -euo pipefail

                TARGET_ENV='$(targetEnvironment)'
                ARTIFACT_PATH="$(Pipeline.Workspace)/infra-outputs/deployment-${TARGET_ENV}.json"

                API_HOST=""
                if [ -f "$ARTIFACT_PATH" ]; then
                  API_HOST=$(jq -r '.apiUrl // empty' "$ARTIFACT_PATH")
                  if [ "$API_HOST" = "null" ]; then
                    API_HOST=""
                  fi
                fi

                if [ -z "$API_HOST" ]; then
                  RESOURCE_GROUP="rg-nba-stats-${TARGET_ENV}"
                  APP_NAME="nba-stats-${TARGET_ENV}-api"
                  FQDN=$(az containerapp show --name "$APP_NAME" --resource-group "$RESOURCE_GROUP" --query 'properties.configuration.ingress.fqdn' -o tsv 2>/dev/null || true)
                  if [ -n "$FQDN" ]; then
                    API_HOST="https://${FQDN}"
                  fi
                fi

                if [ -z "$API_HOST" ]; then
                  echo "Unable to resolve API endpoint for environment '$TARGET_ENV'." >&2
                  exit 1
                fi

                API_URL="${API_HOST%/}/api"

                VERSION=$(jq -r '.version' "$(Build.SourcesDirectory)/frontend/package.json")
                SHORT_SHA=$(git rev-parse --short=7 HEAD)
                IMAGE_TAG="${VERSION}-${SHORT_SHA}"

                echo "Resolved API URL: $API_URL"
                echo "Image Tag: $IMAGE_TAG"

                echo "##vso[task.setvariable variable=viteApiUrl]$API_URL"
                echo "##vso[task.setvariable variable=imageTag]$IMAGE_TAG"

          - task: Docker@2
            displayName: 'Build and push to Prod ACR'
            inputs:
              containerRegistry: 'acr-nba-stats-prod'
              repository: '$(imageName)'
              command: 'buildAndPush'
              Dockerfile: '$(dockerfilePath)'
              buildContext: '$(buildContext)'
              tags: |
                $(imageTag)
                latest
              arguments: '--build-arg VITE_API_URL=$(viteApiUrl)'

  # ==============================================================================
  # STAGE 7: Deploy to Dev Container App
  # ==============================================================================
  - stage: Deploy_Dev
    displayName: 'Deploy: Dev'
    dependsOn: Publish_Dev
    condition: and(succeeded(), eq(variables['Build.SourceBranch'], 'refs/heads/main'))
    jobs:
      - deployment: DeployToContainerApp
        displayName: 'Deploy to Dev Container App'
        pool:
          vmImage: $(vmImage)
        environment: 'nba-stats-dev'
        strategy:
          runOnce:
            deploy:
              steps:
                - checkout: self

                - task: Bash@3
                  displayName: 'Generate image tag'
                  inputs:
                    targetType: 'inline'
                    script: |
                      VERSION=$(cat $(Build.SourcesDirectory)/frontend/package.json | jq -r '.version')
                      SHORT_SHA=$(git rev-parse --short=7 HEAD)
                      IMAGE_TAG="${VERSION}-${SHORT_SHA}"
                      echo "##vso[task.setvariable variable=imageTag]$IMAGE_TAG"
                      echo "Image Tag: $IMAGE_TAG"

                - task: AzureCLI@2
                  displayName: 'Update Container App with new image'
                  inputs:
                    azureSubscription: 'azure-nba-stats-connection'
                    scriptType: 'bash'
                    scriptLocation: 'inlineScript'
                    inlineScript: |
                      REGISTRY_NAME=$(az acr list --resource-group rg-nba-stats-dev --query "[0].name" -o tsv)
                      IMAGE_NAME="${REGISTRY_NAME}.azurecr.io/$(imageName):$(imageTag)"
                      
                      echo "Updating Container App with image: $IMAGE_NAME"
                      
                      az containerapp update \
                        --name nba-stats-dev-frontend \
                        --resource-group rg-nba-stats-dev \
                        --image "$IMAGE_NAME" \
                        --output table
                      
                      echo "Deployment complete!"

  # ==============================================================================
  # STAGE 8: Deploy to Test Container App
  # ==============================================================================
  - stage: Deploy_Test
    displayName: 'Deploy: Test'
    dependsOn: Publish_Test
    condition: and(succeeded(), eq(variables['Build.SourceBranch'], 'refs/heads/main'))
    jobs:
      - deployment: DeployToContainerApp
        displayName: 'Deploy to Test Container App'
        pool:
          vmImage: $(vmImage)
        environment: 'nba-stats-test'
        strategy:
          runOnce:
            deploy:
              steps:
                - checkout: self

                - task: Bash@3
                  displayName: 'Generate image tag'
                  inputs:
                    targetType: 'inline'
                    script: |
                      VERSION=$(cat $(Build.SourcesDirectory)/frontend/package.json | jq -r '.version')
                      SHORT_SHA=$(git rev-parse --short=7 HEAD)
                      IMAGE_TAG="${VERSION}-${SHORT_SHA}"
                      echo "##vso[task.setvariable variable=imageTag]$IMAGE_TAG"
                      echo "Image Tag: $IMAGE_TAG"

                - task: AzureCLI@2
                  displayName: 'Update Container App with new image'
                  inputs:
                    azureSubscription: 'azure-nba-stats-connection'
                    scriptType: 'bash'
                    scriptLocation: 'inlineScript'
                    inlineScript: |
                      REGISTRY_NAME=$(az acr list --resource-group rg-nba-stats-test --query "[0].name" -o tsv)
                      IMAGE_NAME="${REGISTRY_NAME}.azurecr.io/$(imageName):$(imageTag)"
                      
                      echo "Updating Container App with image: $IMAGE_NAME"
                      
                      az containerapp update \
                        --name nba-stats-test-frontend \
                        --resource-group rg-nba-stats-test \
                        --image "$IMAGE_NAME" \
                        --output table
                      
                      echo "Deployment complete!"

  # ==============================================================================
  # STAGE 9: Deploy to Prod Container App
  # ==============================================================================
  - stage: Deploy_Prod
    displayName: 'Deploy: Prod'
    dependsOn: Publish_Prod
    condition: and(succeeded(), eq(variables['Build.SourceBranch'], 'refs/heads/main'))
    jobs:
      - deployment: DeployToContainerApp
        displayName: 'Deploy to Prod Container App'
        pool:
          vmImage: $(vmImage)
        environment: 'nba-stats-prod'
        strategy:
          runOnce:
            deploy:
              steps:
                - checkout: self

                - task: Bash@3
                  displayName: 'Generate image tag'
                  inputs:
                    targetType: 'inline'
                    script: |
                      VERSION=$(cat $(Build.SourcesDirectory)/frontend/package.json | jq -r '.version')
                      SHORT_SHA=$(git rev-parse --short=7 HEAD)
                      IMAGE_TAG="${VERSION}-${SHORT_SHA}"
                      echo "##vso[task.setvariable variable=imageTag]$IMAGE_TAG"
                      echo "Image Tag: $IMAGE_TAG"

                - task: AzureCLI@2
                  displayName: 'Update Container App with new image'
                  inputs:
                    azureSubscription: 'azure-nba-stats-connection'
                    scriptType: 'bash'
                    scriptLocation: 'inlineScript'
                    inlineScript: |
                      REGISTRY_NAME=$(az acr list --resource-group rg-nba-stats-prod --query "[0].name" -o tsv)
                      IMAGE_NAME="${REGISTRY_NAME}.azurecr.io/$(imageName):$(imageTag)"
                      
                      echo "Updating Container App with image: $IMAGE_NAME"
                      
                      az containerapp update \
                        --name nba-stats-prod-frontend \
                        --resource-group rg-nba-stats-prod \
                        --image "$IMAGE_NAME" \
                        --output table
                      
                      echo "Deployment complete!"
