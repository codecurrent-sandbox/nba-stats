# NBA Stats API Build Pipeline
# Builds and publishes the Node.js API Docker image to Azure Container Registry

name: 'API-Build-$(Date:yyyyMMdd)-$(Rev:r)'

resources:
  pipelines:
    - pipeline: infraPipeline
      source: 'NBA-Stats-Infra-Deploy'  # Name of the infrastructure pipeline
      trigger: none  # Don't auto-trigger; this pipeline runs independently

trigger:
  branches:
    include:
      - main
  paths:
    include:
      - services/api/**
      - pipelines/build-api.yml

pr:
  branches:
    include:
      - main
  paths:
    include:
      - services/api/**
      - pipelines/build-api.yml

variables:
  - name: nodeVersion
    value: '20.x'
  - name: imageName
    value: 'nba-stats-api'
  - name: dockerfilePath
    value: 'services/api/Dockerfile'
  - name: buildContext
    value: 'services/api'
  - name: vmImage
    value: 'ubuntu-latest'

stages:
  # ==============================================================================
  # STAGE 1: Prep - Setup environment and dependencies
  # ==============================================================================
  - stage: Prep
    displayName: 'Prepare Build Environment'
    jobs:
      - job: PrepareEnvironment
        displayName: 'Setup Node.js and Dependencies'
        pool:
          vmImage: $(vmImage)
        steps:
          - checkout: self
            displayName: 'Checkout source code'

          - task: NodeTool@0
            displayName: 'Setup Node.js $(nodeVersion)'
            inputs:
              versionSpec: $(nodeVersion)

          - task: Cache@2
            displayName: 'Cache npm packages'
            inputs:
              key: 'npm | "$(Agent.OS)" | $(Build.SourcesDirectory)/services/api/package-lock.json'
              path: $(Pipeline.Workspace)/.npm
              restoreKeys: |
                npm | "$(Agent.OS)"

          - task: Bash@3
            displayName: 'Install dependencies'
            inputs:
              targetType: 'inline'
              workingDirectory: '$(Build.SourcesDirectory)/services/api'
              script: |
                npm ci --cache $(Pipeline.Workspace)/.npm --prefer-offline
                echo "Dependencies installed successfully"

  # ==============================================================================
  # STAGE 2: Quality - Linting (no tests per requirements)
  # ==============================================================================
  - stage: Quality
    displayName: 'Code Quality Checks'
    dependsOn: Prep
    jobs:
      - job: Lint
        displayName: 'Run ESLint'
        pool:
          vmImage: $(vmImage)
        steps:
          - checkout: self

          - task: NodeTool@0
            displayName: 'Setup Node.js $(nodeVersion)'
            inputs:
              versionSpec: $(nodeVersion)

          - task: Cache@2
            displayName: 'Restore npm cache'
            inputs:
              key: 'npm | "$(Agent.OS)" | $(Build.SourcesDirectory)/services/api/package-lock.json'
              path: $(Pipeline.Workspace)/.npm

          - task: Bash@3
            displayName: 'Install dependencies'
            inputs:
              targetType: 'inline'
              workingDirectory: '$(Build.SourcesDirectory)/services/api'
              script: |
                npm ci --cache $(Pipeline.Workspace)/.npm --prefer-offline

          - task: Bash@3
            displayName: 'Run ESLint'
            inputs:
              targetType: 'inline'
              workingDirectory: '$(Build.SourcesDirectory)/services/api'
              script: |
                echo "Running ESLint validation..."
                npm run lint
                echo "ESLint validation completed successfully"

  # ==============================================================================
  # STAGE 3: Build - Docker image build with semantic versioning
  # ==============================================================================
  - stage: Build
    displayName: 'Build Docker Image'
    dependsOn: Quality
    jobs:
      - job: BuildImage
        displayName: 'Build and Tag Docker Image'
        pool:
          vmImage: $(vmImage)
        steps:
          - checkout: self

          - task: Bash@3
            displayName: 'Extract version and generate tags'
            inputs:
              targetType: 'inline'
              script: |
                # Extract version from package.json
                VERSION=$(cat $(Build.SourcesDirectory)/services/api/package.json | jq -r '.version')
                
                # Get short git SHA
                SHORT_SHA=$(git rev-parse --short=7 HEAD)
                
                # Full commit SHA
                FULL_SHA=$(git rev-parse HEAD)
                
                # Generate image tag: {version}-{sha}
                IMAGE_TAG="${VERSION}-${SHORT_SHA}"
                
                # Set pipeline variables
                echo "##vso[task.setvariable variable=packageVersion]$VERSION"
                echo "##vso[task.setvariable variable=shortSha]$SHORT_SHA"
                echo "##vso[task.setvariable variable=fullSha]$FULL_SHA"
                echo "##vso[task.setvariable variable=imageTag]$IMAGE_TAG"
                
                echo "Package Version: $VERSION"
                echo "Short SHA: $SHORT_SHA"
                echo "Image Tag: $IMAGE_TAG"

          - task: Docker@2
            displayName: 'Build Docker image'
            inputs:
              command: 'build'
              Dockerfile: '$(dockerfilePath)'
              buildContext: '$(buildContext)'
              tags: |
                $(imageTag)
                latest
              arguments: '--build-arg NODE_VERSION=$(nodeVersion)'

  # ==============================================================================
  # STAGE 4: Publish to Dev ACR
  # ==============================================================================
  - stage: Publish_Dev
    displayName: 'Publish: Dev'
    dependsOn: Build
    condition: and(succeeded(), eq(variables['Build.SourceBranch'], 'refs/heads/main'))
    jobs:
      - job: PushToACR
        displayName: 'Push to Dev ACR'
        pool:
          vmImage: $(vmImage)
        steps:
          - checkout: self

          - task: DownloadPipelineArtifact@2
            displayName: 'Download infrastructure outputs (Dev)'
            continueOnError: true
            inputs:
              source: 'specific'
              project: '$(System.TeamProject)'
              pipeline: 'NBA-Stats-Infra-Deploy'
              runVersion: 'latest'
              artifact: 'deployment-dev'
              path: '$(Pipeline.Workspace)/infra-outputs'

          - task: Bash@3
            displayName: 'Generate version tags'
            inputs:
              targetType: 'inline'
              script: |
                VERSION=$(cat $(Build.SourcesDirectory)/services/api/package.json | jq -r '.version')
                SHORT_SHA=$(git rev-parse --short=7 HEAD)
                IMAGE_TAG="${VERSION}-${SHORT_SHA}"
                
                echo "##vso[task.setvariable variable=packageVersion]$VERSION"
                echo "##vso[task.setvariable variable=shortSha]$SHORT_SHA"
                echo "##vso[task.setvariable variable=imageTag]$IMAGE_TAG"
                echo "Version: $VERSION, Tag: $IMAGE_TAG"

          - task: Docker@2
            displayName: 'Build and push to Dev ACR'
            inputs:
              containerRegistry: 'acr-nba-stats-dev'
              repository: '$(imageName)'
              command: 'buildAndPush'
              Dockerfile: '$(dockerfilePath)'
              buildContext: '$(buildContext)'
              tags: |
                $(imageTag)
                latest

  # ==============================================================================
  # STAGE 5: Publish to Test ACR
  # ==============================================================================
  - stage: Publish_Test
    displayName: 'Publish: Test'
    dependsOn: Publish_Dev
    condition: and(succeeded(), eq(variables['Build.SourceBranch'], 'refs/heads/main'))
    jobs:
      - job: PushToACR
        displayName: 'Push to Test ACR'
        pool:
          vmImage: $(vmImage)
        steps:
          - checkout: self

          - task: DownloadPipelineArtifact@2
            displayName: 'Download infrastructure outputs (Test)'
            continueOnError: true
            inputs:
              source: 'specific'
              project: '$(System.TeamProject)'
              pipeline: 'NBA-Stats-Infra-Deploy'
              runVersion: 'latest'
              artifact: 'deployment-test'
              path: '$(Pipeline.Workspace)/infra-outputs'

          - task: Bash@3
            displayName: 'Generate version tags'
            inputs:
              targetType: 'inline'
              script: |
                VERSION=$(cat $(Build.SourcesDirectory)/services/api/package.json | jq -r '.version')
                SHORT_SHA=$(git rev-parse --short=7 HEAD)
                IMAGE_TAG="${VERSION}-${SHORT_SHA}"
                
                echo "##vso[task.setvariable variable=imageTag]$IMAGE_TAG"
                echo "Tag: $IMAGE_TAG"

          - task: Docker@2
            displayName: 'Build and push to Test ACR'
            inputs:
              containerRegistry: 'acr-nba-stats-test'
              repository: '$(imageName)'
              command: 'buildAndPush'
              Dockerfile: '$(dockerfilePath)'
              buildContext: '$(buildContext)'
              tags: |
                $(imageTag)
                latest

  # ==============================================================================
  # STAGE 6: Publish to Prod ACR
  # ==============================================================================
  - stage: Publish_Prod
    displayName: 'Publish: Prod'
    dependsOn: Publish_Test
    condition: and(succeeded(), eq(variables['Build.SourceBranch'], 'refs/heads/main'))
    jobs:
      - job: PushToACR
        displayName: 'Push to Prod ACR'
        pool:
          vmImage: $(vmImage)
        steps:
          - checkout: self

          - task: DownloadPipelineArtifact@2
            displayName: 'Download infrastructure outputs (Prod)'
            continueOnError: true
            inputs:
              source: 'specific'
              project: '$(System.TeamProject)'
              pipeline: 'NBA-Stats-Infra-Deploy'
              runVersion: 'latest'
              artifact: 'deployment-prod'
              path: '$(Pipeline.Workspace)/infra-outputs'

          - task: Bash@3
            displayName: 'Generate version tags'
            inputs:
              targetType: 'inline'
              script: |
                VERSION=$(cat $(Build.SourcesDirectory)/services/api/package.json | jq -r '.version')
                SHORT_SHA=$(git rev-parse --short=7 HEAD)
                IMAGE_TAG="${VERSION}-${SHORT_SHA}"
                
                echo "##vso[task.setvariable variable=imageTag]$IMAGE_TAG"
                echo "Tag: $IMAGE_TAG"

          - task: Docker@2
            displayName: 'Build and push to Prod ACR'
            inputs:
              containerRegistry: 'acr-nba-stats-prod'
              repository: '$(imageName)'
              command: 'buildAndPush'
              Dockerfile: '$(dockerfilePath)'
              buildContext: '$(buildContext)'
              tags: |
                $(imageTag)
                latest
